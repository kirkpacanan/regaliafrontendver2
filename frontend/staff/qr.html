<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QR Check-in | Regalia Staff</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./staff.css" />
  </head>
  <body>
    <div class="dashboard">
      <div class="sidebar-overlay" data-sidebar-overlay></div>
      <aside class="sidebar">
        <div class="brand">
          <img class="brand-logo" src="../logo.png" alt="Regalia" />
        </div>
        <button class="menu-toggle" type="button" data-sidebar-close>
          <svg viewBox="0 0 24 24">
            <line x1="6" y1="6" x2="18" y2="18"></line>
            <line x1="6" y1="18" x2="18" y2="6"></line>
          </svg>
          Close
        </button>
        <nav class="nav">
          <a href="./index.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              </svg>
            </span>
            Dashboard
          </a>
          <a class="active" href="./qr.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M7 3H3v4M7 21H3v-4M17 3h4v4M17 21h4v-4"></path>
                <path d="M7 7h4v4H7zM13 13h4v4h-4z"></path>
              </svg>
            </span>
            QR Check-in
          </a>
          <a href="./bookings.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
            </span>
            Bookings
          </a>
          <a href="./guests.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </span>
            Guests
          </a>
          <a href="./messages.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
              </svg>
            </span>
            Messages
          </a>
        </nav>
        <div class="sidebar-footer">
          <a href="#">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.8 1.8 0 0 0 .3 2l-1.4 2.4a1.8 1.8 0 0 1-2.2.8l-1.6-.6a7 7 0 0 1-2.4 1.4l-.2 1.8a1.8 1.8 0 0 1-1.8 1.6H9a1.8 1.8 0 0 1-1.8-1.6l-.2-1.8a7 7 0 0 1-2.4-1.4l-1.6.6a1.8 1.8 0 0 1-2.2-.8L.4 17a1.8 1.8 0 0 0 .3-2l1-1.4a7 7 0 0 1 0-2.8l-1-1.4a1.8 1.8 0 0 0-.3-2L1.8 4a1.8 1.8 0 0 1 2.2-.8l1.6.6a7 7 0 0 1 2.4-1.4l.2-1.8A1.8 1.8 0 0 1 10 0h4a1.8 1.8 0 0 1 1.8 1.6l.2 1.8a7 7 0 0 1 2.4 1.4l1.6-.6a1.8 1.8 0 0 1 2.2.8l1.4 2.4a1.8 1.8 0 0 0-.3 2l-1 1.4a7 7 0 0 1 0 2.8z"
                ></path>
              </svg>
            </span>
            Settings
          </a>
          <a href="../index.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <polyline points="10 17 15 12 10 7"></polyline>
                <line x1="15" y1="12" x2="3" y2="12"></line>
              </svg>
            </span>
            Logout
          </a>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <button class="menu-toggle" type="button" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24">
              <line x1="4" y1="7" x2="20" y2="7"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="17" x2="20" y2="17"></line>
            </svg>
          </button>
          <div>
            <h1>QR Check-in</h1>
            <p>Scan and validate guest arrivals quickly.</p>
          </div>
          <div class="top-actions">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M18 8a6 6 0 0 0-12 0c0 7-3 8-3 8h18s-3-1-3-8"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
            </span>
            <div class="avatar">FD</div>
          </div>
        </header>

        <section class="content-grid qr-grid">
          <div class="panel">
            <h3>Scanner Status</h3>
            <div class="list">
              <div class="list-item">
                <div>
                  Camera: Online
                  <small>Last heartbeat: 2s ago</small>
                </div>
                <span class="icon">
                  <svg viewBox="0 0 24 24">
                    <circle cx="12" cy="12" r="9"></circle>
                  </svg>
                </span>
              </div>
              <div class="list-item">
                <div>
                  Today’s Scans
                  <small>18 successful • 2 failed</small>
                </div>
                <span class="icon">
                  <svg viewBox="0 0 24 24">
                    <polyline points="5 13 9 17 19 7"></polyline>
                  </svg>
                </span>
              </div>
            </div>
          </div>

          <div class="panel panel-stack">
            <h3>Scan a QR</h3>
            <div class="scan-panel">
              <div class="scan-frame">
                <video class="scan-video" playsinline muted></video>
                <div class="scan-corner top-left"></div>
                <div class="scan-corner top-right"></div>
                <div class="scan-corner bottom-left"></div>
                <div class="scan-corner bottom-right"></div>
                <div class="scan-line"></div>
              </div>
              <div>
                <strong>Camera Ready</strong>
                <p class="muted">
                  Align the guest QR code inside the frame to auto-check in.
                </p>
                <div class="scan-status" data-scan-status>
                  Tap start scan to begin.
                </div>
                <div class="scan-actions">
                  <button class="btn ghost" data-start-scan>Start Scan</button>
                  <button class="btn ghost" data-stop-scan>Stop Scan</button>
                  <button class="btn ghost" data-upload-qr>Upload QR</button>
                </div>
              </div>
            </div>
            <div class="quick-card">
              <div class="quick-icon">
                <svg viewBox="0 0 24 24">
                  <circle cx="11" cy="11" r="7"></circle>
                  <path d="M21 21l-4.3-4.3"></path>
                </svg>
              </div>
              <div>
                <strong>Manual Lookup</strong>
                <p class="muted">Search reservation code or guest name.</p>
              </div>
              <button class="btn ghost" data-manual-lookup>Search Guest</button>
            </div>
            <div class="quick-card">
              <div class="quick-icon">
                <svg viewBox="0 0 24 24">
                  <path d="M22 2 11 13"></path>
                  <path d="M22 2 15 22 11 13 2 9 22 2"></path>
                </svg>
              </div>
              <div>
                <strong>Resend QR</strong>
                <p class="muted">Send QR check-in link by email or SMS.</p>
              </div>
              <button class="btn ghost" data-resend-qr>Resend</button>
            </div>
          </div>
        </section>

        <section class="panel recent-section">
          <h3>Recent Scans</h3>
          <div class="list" data-recent-scans></div>
        </section>
      </main>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="./staffscript.js"></script>
    <script>
      (function () {
        var R = window.RegaliaStaff;
        var API = R ? R.API : "/api";
        var startButton = document.querySelector("[data-start-scan]");
        var stopButton = document.querySelector("[data-stop-scan]");
        var scanFrame = document.querySelector(".scan-frame");
        var scanVideo = document.querySelector(".scan-video");
        var scanStatus = document.querySelector("[data-scan-status]");
        var recentList = document.querySelector("[data-recent-scans]");
        var stream = null;
        var scanInterval = null;
        var recentScans = [];

        function addRecentScan(booking) {
          var t = new Date();
          var timeStr = t.getHours() + ":" + (t.getMinutes() < 10 ? "0" : "") + t.getMinutes() + " " + (t.getHours() >= 12 ? "PM" : "AM");
          recentScans.unshift({
            unit: (booking && booking.unit_number) || (booking && booking.unit_id) || "—",
            tower: (booking && booking.tower_name) || "",
            name: (booking && booking.guest_name) || "Guest",
            time: timeStr,
          });
          recentScans = recentScans.slice(0, 20);
          renderRecentScans();
        }

        function renderRecentScans() {
          if (!recentList) return;
          recentList.innerHTML = recentScans.length === 0
            ? "<div class=\"list-item\"><div>No scans yet</div></div>"
            : recentScans.map(function (s) {
                return "<div class=\"list-item\"><div>Unit " + s.unit + (s.tower ? " • " + s.tower : "") + "<small>Scanned " + s.time + " • " + s.name + "</small></div><span class=\"icon\"><svg viewBox=\"0 0 24 24\"><polyline points=\"5 13 9 17 19 7\"></polyline></svg></span></div>";
              }).join("");
        }

        function handleScannedPayload(data) {
          var id = data.booking_id;
          if (!id) return;
          fetch(API + "/bookings/" + id).then(function (r) { return r.ok ? r.json() : null; }).then(function (booking) {
            if (!booking) { if (scanStatus) scanStatus.textContent = "Booking not found."; return; }
            if (booking.status !== "confirmed") { if (scanStatus) scanStatus.textContent = "Booking not confirmed."; return; }
            var checkedIn = !!booking.checked_in_at;
            var checkedOut = !!booking.checked_out_at;
            if (!checkedIn) {
              R.postCheckIn(id).then(function () {
                if (scanStatus) scanStatus.textContent = "Check-in recorded: " + (booking.guest_name || "Guest");
                addRecentScan(booking);
              }).catch(function (e) {
                if (scanStatus) scanStatus.textContent = e.message || "Check-in failed";
              });
            } else if (!checkedOut) {
              R.postCheckOut(id).then(function () {
                if (scanStatus) scanStatus.textContent = "Check-out recorded: " + (booking.guest_name || "Guest");
                addRecentScan(booking);
              }).catch(function (e) {
                if (scanStatus) scanStatus.textContent = e.message || "Check-out failed";
              });
            } else {
              if (scanStatus) scanStatus.textContent = "Already checked out.";
            }
          });
        }

        function tryDecodeFromVideo() {
          if (!scanVideo || !scanVideo.videoWidth || !window.jsQR) return;
          var canvas = document.createElement("canvas");
          canvas.width = scanVideo.videoWidth;
          canvas.height = scanVideo.videoHeight;
          var ctx = canvas.getContext("2d");
          ctx.drawImage(scanVideo, 0, 0);
          var imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          var code = jsQR(imageData.data, imageData.width, imageData.height);
          if (code && code.data) {
            try {
              var data = JSON.parse(code.data);
              if (data.booking_id) {
                if (scanInterval) clearInterval(scanInterval);
                scanInterval = null;
                handleScannedPayload(data);
              }
            } catch (e) {}
          }
        }

        function startScan() {
          if (!scanVideo || !scanFrame) return;
          scanFrame.classList.add("is-scanning");
          if (scanStatus) scanStatus.textContent = "Starting camera...";
          navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false }).then(function (s) {
            stream = s;
            scanVideo.srcObject = stream;
            scanVideo.play();
            if (scanStatus) scanStatus.textContent = "Scanning... hold QR steady.";
            scanInterval = setInterval(tryDecodeFromVideo, 300);
          }).catch(function () {
            if (scanStatus) scanStatus.textContent = "Camera blocked. Use Manual Lookup or Upload QR.";
          });
        }

        function stopScan() {
          if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
          if (stream) { stream.getTracks().forEach(function (t) { t.stop(); }); stream = null; }
          if (scanVideo) { scanVideo.pause(); scanVideo.srcObject = null; }
          if (scanFrame) scanFrame.classList.remove("is-scanning");
          if (scanStatus) scanStatus.textContent = "Tap start scan to begin.";
        }

        if (startButton) startButton.addEventListener("click", startScan);
        if (stopButton) stopButton.addEventListener("click", stopScan);

        var uploadBtn = document.querySelector("[data-upload-qr]");
        if (uploadBtn) {
          var input = document.createElement("input");
          input.type = "file";
          input.accept = "image/*";
          input.style.display = "none";
          document.body.appendChild(input);
          uploadBtn.addEventListener("click", function () { input.click(); });
          input.addEventListener("change", function () {
            var f = input.files && input.files[0];
            if (!f) return;
            var img = new Image();
            img.onload = function () {
              var c = document.createElement("canvas");
              c.width = img.width;
              c.height = img.height;
              var ctx = c.getContext("2d");
              ctx.drawImage(img, 0, 0);
              try {
                var d = ctx.getImageData(0, 0, c.width, c.height);
                var code = jsQR(d.data, d.width, d.height);
                if (code && code.data) {
                  var data = JSON.parse(code.data);
                  if (data.booking_id) handleScannedPayload(data);
                } else if (scanStatus) scanStatus.textContent = "No QR code found in image.";
              } catch (e) { if (scanStatus) scanStatus.textContent = "Invalid QR or image."; }
            };
            img.src = URL.createObjectURL(f);
          });
        }

        var manualSearchBtn = document.querySelector("[data-manual-lookup]");
        if (manualSearchBtn) {
          manualSearchBtn.addEventListener("click", function () {
            var q = prompt("Search by guest name or booking ref (e.g. REG-00008):");
            if (!q || !R) return;
            R.getBookings().then(function (bookings) {
              var qq = q.trim().toLowerCase();
              var refMatch = qq.match(/reg-?(\d+)/);
              var id = refMatch ? parseInt(refMatch[1], 10) : null;
              var filtered = bookings.filter(function (b) {
                if (id && b.booking_id === id) return true;
                return (b.guest_name && b.guest_name.toLowerCase().indexOf(qq) !== -1) ||
                  (b.email && b.email.toLowerCase().indexOf(qq) !== -1);
              });
              if (filtered.length === 0) { alert("No bookings found."); return; }
              if (filtered.length === 1) {
                var b = filtered[0];
                var action = b.checked_in_at && !b.checked_out_at ? "Check out" : "Check in";
                if (!confirm(b.guest_name + " • Unit " + (b.unit_number || b.unit_id) + "\n" + action + "?")) return;
                if (b.checked_in_at && !b.checked_out_at) R.postCheckOut(b.booking_id).then(function () { alert("Check-out recorded."); addRecentScan(b); }).catch(function (e) { alert(e.message); });
                else R.postCheckIn(b.booking_id).then(function () { alert("Check-in recorded."); addRecentScan(b); }).catch(function (e) { alert(e.message); });
              } else {
                var msg = filtered.slice(0, 5).map(function (b, i) { return (i + 1) + ". " + b.guest_name + " (REG-" + String(b.booking_id).padStart(5, "0") + ")"; }).join("\n");
                alert("Multiple matches. Refine search.\n\n" + msg);
              }
            });
          });
        }

        var resendBtn = document.querySelector("[data-resend-qr]");
        if (resendBtn) {
          resendBtn.addEventListener("click", function () {
            var idStr = prompt("Booking ID or ref (e.g. 8 or REG-00008):");
            if (!idStr || !R) return;
            var refMatch = idStr.trim().match(/reg-?(\d+)/i);
            var id = refMatch ? parseInt(refMatch[1], 10) : parseInt(idStr, 10);
            if (!id) { alert("Invalid ID."); return; }
            R.resendQr(id).then(function () { alert("QR email resent."); }).catch(function (e) { alert(e.message || "Failed"); });
          });
        }

        renderRecentScans();
      })();
      const toggle = document.querySelector(".topbar .menu-toggle");
      const closeButton = document.querySelector("[data-sidebar-close]");
      const overlay = document.querySelector("[data-sidebar-overlay]");
      const navLinks = document.querySelectorAll(".sidebar .nav a");

      const closeSidebar = () => document.body.classList.remove("sidebar-open");
      const toggleSidebar = () =>
        document.body.classList.toggle("sidebar-open");

      if (toggle) toggle.addEventListener("click", toggleSidebar);
      if (closeButton) closeButton.addEventListener("click", closeSidebar);
      if (overlay) overlay.addEventListener("click", closeSidebar);
      navLinks.forEach((link) => link.addEventListener("click", closeSidebar));
    </script>
  </body>
</html>
