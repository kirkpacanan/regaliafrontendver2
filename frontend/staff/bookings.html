<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bookings | Regalia Staff</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="./staff.css" />
  </head>
  <body>
    <div class="dashboard">
      <div class="sidebar-overlay" data-sidebar-overlay></div>
      <aside class="sidebar">
        <div class="brand">
          <img class="brand-logo" src="../logo.png" alt="Regalia" />
        </div>
        <button class="menu-toggle" type="button" data-sidebar-close>
          <svg viewBox="0 0 24 24">
            <line x1="6" y1="6" x2="18" y2="18"></line>
            <line x1="6" y1="18" x2="18" y2="6"></line>
          </svg>
          Close
        </button>
        <nav class="nav">
          <a href="./index.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <rect x="3" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="3" width="7" height="7" rx="1"></rect>
                <rect x="14" y="14" width="7" height="7" rx="1"></rect>
                <rect x="3" y="14" width="7" height="7" rx="1"></rect>
              </svg>
            </span>
            Dashboard
          </a>
          <a href="./qr.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M7 3H3v4M7 21H3v-4M17 3h4v4M17 21h4v-4"></path>
                <path d="M7 7h4v4H7zM13 13h4v4h-4z"></path>
              </svg>
            </span>
            QR Check-in
          </a>
          <a class="active" href="./bookings.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                <path d="M16 2v4M8 2v4M3 10h18"></path>
              </svg>
            </span>
            Bookings
          </a>
          <a href="./guests.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M17 21v-2a4 4 0 0 0-4-4H7a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </span>
            Guests
          </a>
          <a href="./messages.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M21 15a4 4 0 0 1-4 4H7l-4 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
              </svg>
            </span>
            Messages
          </a>
        </nav>
        <div class="sidebar-footer">
          <a href="#">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="3"></circle>
                <path
                  d="M19.4 15a1.8 1.8 0 0 0 .3 2l-1.4 2.4a1.8 1.8 0 0 1-2.2.8l-1.6-.6a7 7 0 0 1-2.4 1.4l-.2 1.8a1.8 1.8 0 0 1-1.8 1.6H9a1.8 1.8 0 0 1-1.8-1.6l-.2-1.8a7 7 0 0 1-2.4-1.4l-1.6.6a1.8 1.8 0 0 1-2.2-.8L.4 17a1.8 1.8 0 0 0 .3-2l1-1.4a7 7 0 0 1 0-2.8l-1-1.4a1.8 1.8 0 0 0-.3-2L1.8 4a1.8 1.8 0 0 1 2.2-.8l1.6.6a7 7 0 0 1 2.4-1.4l.2-1.8A1.8 1.8 0 0 1 10 0h4a1.8 1.8 0 0 1 1.8 1.6l.2 1.8a7 7 0 0 1 2.4 1.4l1.6-.6a1.8 1.8 0 0 1 2.2.8l1.4 2.4a1.8 1.8 0 0 0-.3 2l-1 1.4a7 7 0 0 1 0 2.8z"
                ></path>
              </svg>
            </span>
            Settings
          </a>
          <a href="../index.html">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <polyline points="10 17 15 12 10 7"></polyline>
                <line x1="15" y1="12" x2="3" y2="12"></line>
              </svg>
            </span>
            Logout
          </a>
        </div>
      </aside>

      <main class="main">
        <header class="topbar">
          <button class="menu-toggle" type="button" aria-label="Toggle menu">
            <svg viewBox="0 0 24 24">
              <line x1="4" y1="7" x2="20" y2="7"></line>
              <line x1="4" y1="12" x2="20" y2="12"></line>
              <line x1="4" y1="17" x2="20" y2="17"></line>
            </svg>
          </button>
          <div>
            <h1>Bookings</h1>
            <p>Track arrivals, departures, and approvals.</p>
          </div>
          <div class="top-actions">
            <span class="icon">
              <svg viewBox="0 0 24 24">
                <path d="M18 8a6 6 0 0 0-12 0c0 7-3 8-3 8h18s-3-1-3-8"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
              </svg>
            </span>
            <div class="avatar">FD</div>
          </div>
        </header>

        <section class="stats">
          <div class="stat-card">
            <div class="label">Today</div>
            <div class="value" data-bookings-today>0</div>
          </div>
          <div class="stat-card">
            <div class="label">Pending Approval</div>
            <div class="value" data-bookings-pending>0</div>
          </div>
          <div class="stat-card">
            <div class="label">Upcoming Week</div>
            <div class="value" data-bookings-week>0</div>
          </div>
          <div class="stat-card highlight">
            <div class="label">Priority Unit</div>
            <div class="value" data-bookings-priority>—</div>
          </div>
        </section>

        <section class="panel">
          <h3>Upcoming Bookings</h3>
          <div class="list" data-upcoming-list></div>
        </section>

        <section class="panel calendar-panel">
          <h3>Booking Calendar</h3>
          <div class="calendar">
            <div class="calendar-header">
              <span data-calendar-month-label>—</span>
              <div class="calendar-actions">
                <button class="btn ghost" type="button" data-calendar-prev>Prev</button>
                <button class="btn ghost" type="button" data-calendar-next>Next</button>
              </div>
            </div>
            <div class="calendar-grid" data-calendar-grid></div>
            <div class="calendar-details" data-calendar-details>
              <div class="calendar-details__title">Select a date to view bookings.</div>
              <div class="list"></div>
            </div>
          </div>
        </section>
      </main>
    </div>
    <script src="./staffscript.js"></script>
    <script>
      (function () {
        var R = window.RegaliaStaff;
        var monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        var currentCalendar = new Date();
        var bookingsByDate = {};
        var allBookings = [];

        function buildBookingsByDate(bookings) {
          var map = {};
          bookings.forEach(function (b) {
            var start = new Date(b.check_in_date);
            var end = new Date(b.check_out_date);
            for (var d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
              var key = R.toDateKey(d);
              if (!map[key]) map[key] = [];
              map[key].push(b);
            }
          });
          return map;
        }

        function renderCalendar() {
          var y = currentCalendar.getFullYear();
          var m = currentCalendar.getMonth();
          var label = document.querySelector("[data-calendar-month-label]");
          if (label) label.textContent = monthNames[m] + " " + y;

          var first = new Date(y, m, 1);
          var last = new Date(y, m + 1, 0);
          var startDay = first.getDay();
          var daysInMonth = last.getDate();
          var prevMonth = new Date(y, m, 0);
          var prevDays = prevMonth.getDate();

          var grid = document.querySelector("[data-calendar-grid]");
          if (!grid) return;
          grid.innerHTML = "";

          var dayLabels = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
          dayLabels.forEach(function (d) {
            var cell = document.createElement("div");
            cell.className = "calendar-day";
            cell.textContent = d;
            grid.appendChild(cell);
          });

          for (var i = 0; i < startDay; i++) {
            var cell = document.createElement("div");
            cell.className = "calendar-cell muted";
            var pd = prevDays - startDay + i + 1;
            var prevDate = new Date(y, m - 1, pd);
            cell.dataset.date = R.toDateKey(prevDate);
            cell.textContent = pd;
            grid.appendChild(cell);
          }
          for (var day = 1; day <= daysInMonth; day++) {
            var cell = document.createElement("div");
            cell.className = "calendar-cell";
            var dateKey = y + "-" + (m + 1 < 10 ? "0" : "") + (m + 1) + "-" + (day < 10 ? "0" : "") + day;
            cell.dataset.date = dateKey;
            var count = (bookingsByDate[dateKey] || []).length;
            cell.textContent = day;
            if (count > 0) {
              var badge = document.createElement("span");
              badge.className = "badge";
              badge.textContent = count;
              cell.appendChild(badge);
              cell.classList.add("has-bookings");
            }
            grid.appendChild(cell);
          }
          var remaining = 42 - (startDay + daysInMonth);
          for (var j = 1; j <= remaining; j++) {
            var cell = document.createElement("div");
            cell.className = "calendar-cell muted";
            cell.dataset.date = R.toDateKey(new Date(y, m + 1, j));
            cell.textContent = j;
            grid.appendChild(cell);
          }

          var details = document.querySelector("[data-calendar-details]");
          var list = details ? details.querySelector(".list") : null;
          var title = details ? details.querySelector(".calendar-details__title") : null;
          grid.querySelectorAll(".calendar-cell").forEach(function (cell) {
            cell.addEventListener("click", function () {
              grid.querySelectorAll(".calendar-cell").forEach(function (c) { c.classList.remove("selected"); });
              cell.classList.add("selected");
              var date = cell.dataset.date;
              var bookings = bookingsByDate[date] || [];
              if (!list || !title) return;
              list.innerHTML = "";
              title.textContent = date + " • " + bookings.length + " booking(s)";
              bookings.forEach(function (b) {
                var item = document.createElement("div");
                item.className = "list-item";
                var nights = R.getNights(b.check_in_date, b.check_out_date);
                var status = b.status === "confirmed" ? "Confirmed" : (b.status === "pending" ? "Pending" : b.status);
                var tagClass = b.status === "pending" ? "tag--pending" : "tag--paid";
                item.innerHTML = "<div>Unit " + (b.unit_number || b.unit_id) + " • " + nights + " Night(s)<small>" + (b.guest_name || "Guest") + " • <span class=\"tag " + tagClass + "\">" + status + "</span></small></div><span class=\"icon\"><svg viewBox=\"0 0 24 24\"><polyline points=\"5 13 9 17 19 7\"></polyline></svg></span>";
                list.appendChild(item);
              });
            });
          });
        }

        R.getBookings().then(function (bookings) {
          allBookings = bookings;
          bookingsByDate = buildBookingsByDate(bookings);
          var todayKey = R.toDateKey(new Date());
          var weekEnd = new Date();
          weekEnd.setDate(weekEnd.getDate() + 7);
          var weekKeyEnd = R.toDateKey(weekEnd);
          var todayCount = (bookingsByDate[todayKey] || []).length;
          var pending = bookings.filter(function (b) { return b.status === "pending"; }).length;
          var weekCount = 0;
          for (var k in bookingsByDate) { if (k >= todayKey && k <= weekKeyEnd) weekCount += bookingsByDate[k].length; }
          var firstUnit = bookings.length && bookings[0].unit_type ? bookings[0].unit_type : "—";

          var el = document.querySelector("[data-bookings-today]"); if (el) el.textContent = todayCount;
          el = document.querySelector("[data-bookings-pending]"); if (el) el.textContent = pending;
          el = document.querySelector("[data-bookings-week]"); if (el) el.textContent = weekCount;
          el = document.querySelector("[data-bookings-priority]"); if (el) el.textContent = firstUnit;

          var upcoming = bookings.filter(function (b) {
            return R.toDateKey(b.check_in_date) >= todayKey && (b.status === "confirmed" || b.status === "pending");
          }).slice(0, 10);
          var listEl = document.querySelector("[data-upcoming-list]");
          if (listEl) {
            listEl.innerHTML = upcoming.map(function (b) {
              var nights = R.getNights(b.check_in_date, b.check_out_date);
              var tagClass = b.status === "pending" ? "tag--pending" : "tag--paid";
              var status = b.status === "confirmed" ? "Confirmed" : "Pending";
              return "<div class=\"list-item\"><div>Unit " + (b.unit_number || b.unit_id) + " • " + nights + " Night(s)<small>Check-in: " + R.formatShortDate(b.check_in_date) + " • <span class=\"tag " + tagClass + "\">" + status + "</span></small></div><span class=\"icon\"><svg viewBox=\"0 0 24 24\"><polyline points=\"5 13 9 17 19 7\"></polyline></svg></span></div>";
            }).join("") || "<div class=\"list-item\"><div>No upcoming bookings</div></div>";
          }

          currentCalendar = new Date();
          renderCalendar();
        });

        var prevBtn = document.querySelector("[data-calendar-prev]");
        var nextBtn = document.querySelector("[data-calendar-next]");
        if (prevBtn) prevBtn.addEventListener("click", function () { currentCalendar.setMonth(currentCalendar.getMonth() - 1); renderCalendar(); });
        if (nextBtn) nextBtn.addEventListener("click", function () { currentCalendar.setMonth(currentCalendar.getMonth() + 1); renderCalendar(); });
      })();
      const toggle = document.querySelector(".topbar .menu-toggle");
      const closeButton = document.querySelector("[data-sidebar-close]");
      const overlay = document.querySelector("[data-sidebar-overlay]");
      const navLinks = document.querySelectorAll(".sidebar .nav a");

      const closeSidebar = () => document.body.classList.remove("sidebar-open");
      const toggleSidebar = () =>
        document.body.classList.toggle("sidebar-open");

      if (toggle) toggle.addEventListener("click", toggleSidebar);
      if (closeButton) closeButton.addEventListener("click", closeSidebar);
      if (overlay) overlay.addEventListener("click", closeSidebar);
      navLinks.forEach((link) => link.addEventListener("click", closeSidebar));
    </script>
  </body>
</html>
