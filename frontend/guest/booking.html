<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Regalia Guest Booking</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --teal: #1e9db1;
        --green: #7acb59;
        --panel: rgba(255, 255, 255, 0.22);
        --panel-strong: rgba(255, 255, 255, 0.3);
        --text: #ffffff;
        --muted: rgba(255, 255, 255, 0.92);
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        font-family: "Poppins", "Segoe UI", system-ui, sans-serif;
        min-height: 100vh;
        color: var(--text);
        background: linear-gradient(90deg, var(--teal), var(--green));
      }

      .page {
        padding: 2.4rem 1.6rem 3rem;
        display: grid;
        gap: 1.6rem;
        justify-items: center;
      }

      .hero {
        text-align: center;
        display: grid;
        gap: 0.6rem;
        justify-items: center;
      }

      .hero-logo {
        width: min(220px, 70vw);
        height: auto;
        filter: drop-shadow(0 12px 24px rgba(0, 0, 0, 0.18));
      }

      .hero p {
        margin: 0;
        color: var(--text);
        font-size: 0.9rem;
      }

      .card {
        width: min(920px, 94vw);
        background: var(--panel);
        border-radius: 20px;
        padding: 1.8rem;
        display: grid;
        gap: 1.4rem;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12);
      }

      .card-loading,
      .card-error {
        color: rgba(255, 255, 255, 0.9);
        text-align: center;
        padding: 1.5rem;
      }

      .card-error {
        color: rgba(255, 255, 255, 0.85);
      }

      .image-grid {
        display: grid;
        grid-template-columns: repeat(4, minmax(0, 1fr));
        gap: 0.75rem;
      }

      .image-grid img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.12);
      }

      .details {
        text-align: center;
        display: grid;
        gap: 0.4rem;
      }

      .details h2 {
        margin: 0;
        font-size: 1.25rem;
      }

      .details p {
        margin: 0;
        color: var(--text);
        font-size: 0.85rem;
      }

      .detail-grid {
        display: grid;
        gap: 0.35rem;
        text-align: left;
        font-size: 0.85rem;
        color: var(--text);
      }

      .detail-grid span:first-child {
        font-weight: 600;
        margin-right: 0.35rem;
      }

      .form {
        width: min(920px, 94vw);
        background: var(--panel);
        border-radius: 20px;
        padding: 1.6rem;
        display: grid;
        gap: 1.1rem;
        box-shadow: 0 18px 36px rgba(0, 0, 0, 0.12);
      }

      .section-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.08em;
      }

      .section-title svg {
        width: 18px;
        height: 18px;
        stroke: #ffffff;
        fill: none;
        stroke-width: 2;
        stroke-linecap: round;
        stroke-linejoin: round;
      }

      .field-group {
        display: grid;
        gap: 0.7rem;
      }

      .field-group label {
        font-size: 0.8rem;
        color: var(--text);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .field-group input,
      .field-group textarea,
      .field-group select {
        width: 100%;
        padding: 0.75rem 0.85rem;
        border-radius: 14px;
        border: 1px solid rgba(255, 255, 255, 0.35);
        background: rgba(255, 255, 255, 0.16);
        color: #ffffff;
        font-family: inherit;
      }

      .field-group input:focus,
      .field-group textarea:focus,
      .field-group select:focus {
        outline: none;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.18);
      }

      .field-group input::placeholder,
      .field-group textarea::placeholder {
        color: rgba(255, 255, 255, 0.8);
      }

      .field-row {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0.8rem;
      }

      .field-note {
        font-size: 0.8rem;
        color: var(--text);
        opacity: 0.9;
      }

      .radio-group {
        display: grid;
        gap: 0.4rem;
        font-size: 0.8rem;
        color: var(--text);
      }

      .radio-group label {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.85rem;
        text-transform: none;
        letter-spacing: normal;
        justify-content: flex-start;
      }

      .radio-options {
        display: inline-flex;
        align-items: center;
        gap: 1rem;
      }

      .radio-options label {
        margin: 0;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
      }

      .radio-options input {
        margin: 0;
        width: auto;
        flex: 0 0 auto;
      }

      .undertaking {
        background: rgba(255, 255, 255, 0.14);
        border-radius: 14px;
        padding: 0.9rem 1rem;
        color: var(--text);
        line-height: 1.45;
        font-size: 0.82rem;
      }

      .signature-box {
        background: rgba(255, 255, 255, 0.14);
        border-radius: 14px;
        padding: 0.8rem;
        display: grid;
        gap: 0.6rem;
      }

      .signature-canvas {
        width: 100%;
        height: 140px;
        border-radius: 12px;
        background: #ffffff;
        border: 2px solid rgba(79, 127, 132, 0.35);
        touch-action: none;
      }

      .signature-actions {
        display: flex;
        justify-content: flex-end;
      }

      .signature-label {
        text-align: center;
        color: rgba(255, 255, 255, 0.85);
        font-size: 0.75rem;
      }

      .actions {
        display: flex;
        justify-content: space-between;
        gap: 0.8rem;
      }

      .btn {
        border: none;
        padding: 0.7rem 1.2rem;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
      }

      .btn.secondary {
        background: rgba(255, 255, 255, 0.2);
        color: #ffffff;
      }

      .btn.primary {
        background: linear-gradient(90deg, #1e9db1, #7acb59);
        color: #ffffff;
        box-shadow: 0 12px 26px rgba(30, 157, 177, 0.25);
      }

      @media (max-width: 720px) {
        .image-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }

        .image-grid img {
          height: 110px;
        }

        .field-row {
          grid-template-columns: 1fr;
        }

        .card,
        .form {
          padding: 1.3rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <div class="hero">
        <img class="hero-logo" src="../logo.png" alt="Regalia" />
        <p>Guest Booking Form</p>
      </div>

      <section class="card" data-unit-card>
        <div class="card-loading" data-unit-loading>Loading property…</div>
        <div class="card-content" data-unit-content style="display: none;">
          <div class="image-grid" data-images></div>
          <div class="details">
            <h2 data-unit>Unit</h2>
            <div class="detail-grid">
              <div><span>Location:</span> <span data-location></span></div>
              <div><span>Price:</span> <span data-price></span></div>
              <div><span>Room Type:</span> <span data-room></span></div>
              <div><span>Size:</span> <span data-size></span></div>
              <div><span>Description:</span> <span data-description></span></div>
            </div>
          </div>
        </div>
        <div class="card-error" data-unit-error style="display: none;">No property selected. Use the link from the property listing.</div>
      </section>

      <form class="form" data-booking-form method="post" action="#">
        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            Personal Information
          </div>
          <div class="field-row">
            <input type="text" name="guest_name" placeholder="Name" required />
            <input type="text" name="permanent_address" placeholder="Permanent Address" />
          </div>
          <div class="field-row">
            <input type="text" name="age" placeholder="Age" />
            <input type="text" name="nationality" placeholder="Nationality" />
          </div>
          <div class="field-row">
            <input type="text" name="relation_to_owner" placeholder="Relation to the Unit Owner" />
            <input type="text" name="occupation" placeholder="Occupation" />
          </div>
          <div class="field-row">
            <input type="email" name="email" placeholder="E-mail Address" required />
            <input type="text" name="contact_number" placeholder="Contact Number" />
          </div>
          <div class="field-note">
            Kindly attach a copy of any government issued identification card.
          </div>
          <div class="field-row">
            <input type="file" name="id_document" data-id-document accept="image/*" />
          </div>
        </div>

        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <path d="M3 21h18"></path>
              <path d="M5 21V7l7-4 7 4v14"></path>
              <path d="M9 21v-6h6v6"></path>
            </svg>
            Unit Details
          </div>
          <div class="field-row">
            <input type="text" placeholder="Unit Number/Tower" data-prefill-unit readonly />
            <input type="text" name="owner_name" placeholder="Name of Owner" />
          </div>
          <div class="field-row">
            <input type="text" name="owner_contact" placeholder="Contact Number/s" />
            <input type="text" name="inclusive_dates" placeholder="Inclusive Dates (e.g. Nov 20 - Nov 27)" />
          </div>
          <div class="field-row">
            <input type="date" name="check_in_date" placeholder="Check-in date" />
            <input type="date" name="check_out_date" placeholder="Check-out date" />
          </div>
        </div>

        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <rect x="3" y="4" width="18" height="18" rx="2"></rect>
              <path d="M16 2v4M8 2v4M3 10h18"></path>
            </svg>
            Length of Stay
          </div>
          <div class="field-row">
            <input type="text" name="purpose_of_stay" placeholder="Purpose of Stay" />
            <div class="radio-group">
              <span>Did you pay for your stay?</span>
              <div class="radio-options">
                <label><input type="radio" name="paid" value="Yes" /> Yes</label>
                <label><input type="radio" name="paid" value="No" /> No</label>
              </div>
            </div>
          </div>
          <div class="field-row">
            <input type="text" name="amount_paid" placeholder="If YES, how much did you pay?" />
            <input type="text" name="booking_platform" placeholder="Which booking platform did you booked your stay?" />
          </div>
        </div>

        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2"></rect>
              <path d="M3 9h18"></path>
              <path d="M7 14h4"></path>
            </svg>
            Proof of Payment
          </div>
          <div class="field-row">
            <select name="payment_method" data-payment-method>
              <option value="upload">Upload Proof</option>
              <option value="cash">Cash</option>
            </select>
            <input type="file" data-payment-upload accept="image/*" name="payment_proof" />
          </div>
        </div>

        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <path d="M4 4h16v16H4z"></path>
              <path d="M8 8h8M8 12h8M8 16h5"></path>
            </svg>
            Undertaking
          </div>
          <div class="undertaking">
            In signing this form, I acknowledge that I gave the foregoing personal
            information knowingly and voluntarily. I also hereby declare that I
            had been informed of the House Rules and Regulations of Abreeza Place
            prior to my stay and shall fully comply therewith pursuant to
            paragraph 1.2 of the House Rules which states: “1.2 All unit owners
            are required to comply with these House Rules which must likewise be
            observed by (a) members of their family and their household help;
            (b) their lessees and members of the family and household help of
            said lessees; (c) their guests and the guests of their lessees; (d)
            those transacting business with or visiting the condominium.” I also
            hereby agree that I am liable, together with the unit owner, in the
            event that I violate any such House Rules and Regulations. I also
            certify that the foregoing information are true and correct, and
            that any misdeclaration herein can make me liable.
          </div>
        </div>

        <div class="field-group">
          <div class="section-title">
            <svg viewBox="0 0 24 24">
              <path d="M4 20h7"></path>
              <path d="M14 4l6 6"></path>
              <path d="M20 10l-9 9H5v-6l9-9z"></path>
            </svg>
            Signature
          </div>
          <div class="signature-box">
            <canvas class="signature-canvas" data-signature></canvas>
            <div class="signature-actions">
              <button class="btn secondary" type="button" data-clear-sign>
                Clear
              </button>
            </div>
            <div class="signature-label">Signature Over Printed Name</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn secondary" type="button" data-cancel-booking>Cancel</button>
          <button class="btn primary" type="button" data-submit-booking>Submit Booking</button>
        </div>
      </form>
    </div>

    <script>
      (function () {
        const params = new URLSearchParams(window.location.search);
        const unitId = params.get("unit_id");

        const card = document.querySelector("[data-unit-card]");
        const loadingEl = document.querySelector("[data-unit-loading]");
        const contentEl = document.querySelector("[data-unit-content]");
        const errorEl = document.querySelector("[data-unit-error]");
        const imagesEl = document.querySelector("[data-images]");
        const prefillUnit = document.querySelector("[data-prefill-unit]");

        function setText(selector, value) {
          const el = document.querySelector(selector);
          if (el) el.textContent = value || "—";
        }

        function showContent() {
          if (loadingEl) loadingEl.style.display = "none";
          if (errorEl) errorEl.style.display = "none";
          if (contentEl) contentEl.style.display = "";
        }

        function showError() {
          if (loadingEl) loadingEl.style.display = "none";
          if (contentEl) contentEl.style.display = "none";
          if (errorEl) errorEl.style.display = "block";
        }

        if (!unitId) {
          showError();
        } else {
          fetch("/api/units/" + unitId)
            .then(function (r) {
              if (!r.ok) throw new Error("Unit not found");
              return r.json();
            })
            .then(function (unit) {
              showContent();
              setText("[data-unit]", unit.unit_number ? "Unit " + unit.unit_number : "Unit");
              setText("[data-location]", unit.tower_name || "");
              setText("[data-price]", unit.price != null && unit.price !== "" ? "₱ " + unit.price : "—");
              setText("[data-room]", unit.unit_type || "");
              setText("[data-size]", unit.unit_size != null ? unit.unit_size + " sqm" : "—");
              setText("[data-description]", unit.description || "");

              if (imagesEl) {
                imagesEl.innerHTML = "";
                var urls = [];
                try {
                  if (unit.image_urls) {
                    var arr = typeof unit.image_urls === "string" ? JSON.parse(unit.image_urls) : unit.image_urls;
                    if (Array.isArray(arr)) urls = arr.filter(function (s) { return s && (typeof s === "string" ? s : s.url || s.src); }).map(function (s) { return typeof s === "string" ? s : (s.url || s.src); });
                  }
                } catch (e) {}
                if (urls.length === 0) {
                  imagesEl.innerHTML = "<div style='color: rgba(255,255,255,0.7)'>No images</div>";
                } else {
                  urls.forEach(function (src) {
                    var img = document.createElement("img");
                    img.src = src;
                    img.alt = unit.unit_number || "Unit";
                    imagesEl.appendChild(img);
                  });
                }
              }

              if (prefillUnit) prefillUnit.value = (unit.unit_number || "") + (unit.tower_name ? " · " + unit.tower_name : "");
              var formEl = document.querySelector("[data-booking-form]");
              if (formEl) formEl.dataset.unitId = unit.unit_id;
            })
            .catch(function () {
              showError();
            });
        }
      })();

      function getFormData() {
        var form = document.querySelector("[data-booking-form]");
        var unitId = form && form.dataset.unitId;
        var getVal = function (name) {
          var el = form && form.querySelector("[name=\"" + name + "\"]");
          return el ? el.value.trim() : "";
        };
        var paidEl = form && form.querySelector("input[name=\"paid\"]:checked");
        var data = {
          unit_id: unitId || null,
          guest_name: getVal("guest_name"),
          permanent_address: getVal("permanent_address") || null,
          age: getVal("age") || null,
          nationality: getVal("nationality") || null,
          relation_to_owner: getVal("relation_to_owner") || null,
          occupation: getVal("occupation") || null,
          email: getVal("email"),
          contact_number: getVal("contact_number") || null,
          owner_name: getVal("owner_name") || null,
          owner_contact: getVal("owner_contact") || null,
          inclusive_dates: getVal("inclusive_dates") || null,
          check_in_date: getVal("check_in_date") || null,
          check_out_date: getVal("check_out_date") || null,
          purpose_of_stay: getVal("purpose_of_stay") || null,
          paid_yes_no: paidEl ? paidEl.value : null,
          amount_paid: getVal("amount_paid") || null,
          booking_platform: getVal("booking_platform") || null,
          payment_method: (form && form.querySelector("[data-payment-method]")) ? form.querySelector("[data-payment-method]").value : null,
          signature_data: null
        };
        var canvas = document.querySelector("[data-signature]");
        if (canvas && canvas.width && canvas.height) {
          try { data.signature_data = canvas.toDataURL("image/png"); } catch (e) {}
        }
        return data;
      }

      function fileToBase64(file, cb) {
        if (!file) { cb(null); return; }
        var reader = new FileReader();
        reader.onload = function () { cb(reader.result); };
        reader.onerror = function () { cb(null); };
        reader.readAsDataURL(file);
      }

      var submitBtn = document.querySelector("[data-submit-booking]");
      if (submitBtn) {
        submitBtn.addEventListener("click", function () {
          var form = document.querySelector("[data-booking-form]");
          var unitId = form && form.dataset.unitId;
          if (!unitId) {
            alert("No property selected. Use the booking link from the property listing.");
            return;
          }
          var data = getFormData();
          if (!data.guest_name || !data.email) {
            alert("Name and email are required.");
            return;
          }
          var idFile = form && form.querySelector("[data-id-document]");
          var paymentFile = form && form.querySelector("[data-payment-upload]");
          var done = function () {
            fetch("/api/bookings", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data)
            })
              .then(function (r) {
                if (!r.ok) return r.json().then(function (e) { throw new Error(e.error || "Failed"); });
                return r.json();
              })
              .then(function () {
                alert("Booking submitted. The owner will review and confirm or reject.");
                if (form) form.reset();
                var canvas = document.querySelector("[data-signature]");
                if (canvas) { var ctx = canvas.getContext("2d"); ctx.clearRect(0, 0, canvas.width, canvas.height); }
              })
              .catch(function (err) {
                alert(err.message || "Failed to submit booking.");
              });
          };
          if (idFile && idFile.files && idFile.files[0]) {
            fileToBase64(idFile.files[0], function (b64) { data.id_document = b64; next(); });
          } else { data.id_document = null; next(); }
          function next() {
            if (paymentFile && paymentFile.files && paymentFile.files[0]) {
              fileToBase64(paymentFile.files[0], function (b64) { data.payment_proof = b64; done(); });
            } else { data.payment_proof = null; done(); }
          }
        });
      }

      var cancelBtn = document.querySelector("[data-cancel-booking]");
      if (cancelBtn) cancelBtn.addEventListener("click", function () { window.history.back(); });

      const paymentMethod = document.querySelector("[data-payment-method]");
      const paymentUpload = document.querySelector("[data-payment-upload]");
      const syncPayment = () => {
        if (!paymentMethod || !paymentUpload) return;
        const isCash = paymentMethod.value === "cash";
        paymentUpload.disabled = isCash;
        paymentUpload.style.opacity = isCash ? "0.5" : "1";
      };
      if (paymentMethod) {
        paymentMethod.addEventListener("change", syncPayment);
        syncPayment();
      }

      const canvas = document.querySelector("[data-signature]");
      const clearBtn = document.querySelector("[data-clear-sign]");
      if (canvas) {
        const ctx = canvas.getContext("2d");
        const resize = () => {
          const ratio = window.devicePixelRatio || 1;
          canvas.width = canvas.offsetWidth * ratio;
          canvas.height = canvas.offsetHeight * ratio;
          ctx.scale(ratio, ratio);
          ctx.lineWidth = 2;
          ctx.lineCap = "round";
          ctx.strokeStyle = "#2f5f67";
        };
        resize();
        window.addEventListener("resize", resize);

        let drawing = false;
        const start = (event) => {
          drawing = true;
          const { offsetX, offsetY } = event;
          ctx.beginPath();
          ctx.moveTo(offsetX, offsetY);
        };
        const move = (event) => {
          if (!drawing) return;
          const { offsetX, offsetY } = event;
          ctx.lineTo(offsetX, offsetY);
          ctx.stroke();
        };
        const stop = () => {
          drawing = false;
        };

        canvas.addEventListener("pointerdown", start);
        canvas.addEventListener("pointermove", move);
        canvas.addEventListener("pointerup", stop);
        canvas.addEventListener("pointerleave", stop);
      }

      if (clearBtn && canvas) {
        clearBtn.addEventListener("click", () => {
          const ctx = canvas.getContext("2d");
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        });
      }
    </script>
  </body>
</html>
